name: Build VoiceInk
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'VoiceInk.xcodeproj/**'
      - 'whisper.cpp/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Install dependencies
      run: |
        brew install cmake ccache libomp openblas
        
    - name: Show tool versions
      run: |
        xcodebuild -version
        swift --version
        cmake --version
        echo "System architecture: $(uname -m)"
        sysctl -n machdep.cpu.brand_string
      
    - name: Show whisper.cpp version
      run: |
        cd whisper.cpp
        git log --oneline -1
        
    - name: Build whisper.cpp for macOS arm64
      run: 


    - name: List Xcode schemes
      run: xcodebuild -project VoiceInk.xcodeproj -list

    - name: Test whisper module import
      run: |
        echo "ðŸ§ª Testing whisper module import..."
        
        # Create a simple test file to check if the module can be imported
        cat > test_import.swift << 'EOF'
        import Foundation
        #if canImport(whisper)
        import whisper
        print("âœ… Successfully imported whisper module")
        #else
        print("âŒ Cannot import whisper module")
        #endif
        EOF
        
        # Compile using the actual whisper.framework inside the XCFramework
        swiftc -sdk $(xcrun --show-sdk-path --sdk macosx) \
          -target arm64-apple-macos14.0 \
          -F whisper.cpp/build-apple/whisper.xcframework/macos-arm64 \
          -framework whisper \
          -Xlinker -rpath -Xlinker whisper.cpp/build-apple/whisper.xcframework/macos-arm64 \
          -o test_import \
          test_import.swift || echo "âŒ Test compilation failed"
        
        # If compilation succeeded, run the test
        if [ -f test_import ]; then
          echo "ðŸƒ Running import test..."
          ./test_import || echo "âŒ Test execution failed"
          rm test_import
        fi
        
        rm test_import.swift
        
    - name: Build VoiceInk
      run: |
        echo "ðŸ”¨ Building VoiceInk with verbose output..."
        xcodebuild -project VoiceInk.xcodeproj \
          -scheme VoiceInk \
          -configuration Debug \
          -derivedDataPath build \
          -destination 'platform=macOS,arch=arm64' \
          -allowProvisioningUpdates \
          ARCHS='arm64' \
          VALID_ARCHS='arm64' \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -verbose \
          build
          

    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: VoiceInk-build-${{ github.sha }}
        path: |
          build/Build/Products/Debug/VoiceInk.app
          whisper.cpp/build-macos/framework/whisper.framework
          whisper.cpp/build-apple/whisper.xcframework
        retention-days: 30
        
