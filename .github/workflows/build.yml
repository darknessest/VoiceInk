name: Build VoiceInk
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'VoiceInk.xcodeproj/**'
      - 'whisper.cpp/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]

env:
  DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'
        
    - name: Install dependencies
      run: |
        brew install cmake ccache
        
    - name: Show tool versions
      run: |
        xcodebuild -version
        swift --version
        cmake --version
        echo "System architecture: $(uname -m)"
        sysctl -n machdep.cpu.brand_string
      
    - name: Show whisper.cpp version
      run: |
        cd whisper.cpp
        git log --oneline -1
        
    - name: Build whisper.cpp for macOS arm64
      run: |
        cd whisper.cpp
        
        # First build the static libraries
        cmake -B build-macos -G Xcode \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 \
          -DCMAKE_OSX_ARCHITECTURES="arm64" \
          -DBUILD_SHARED_LIBS=OFF \
          -DWHISPER_BUILD_EXAMPLES=OFF \
          -DWHISPER_BUILD_TESTS=OFF \
          -DWHISPER_BUILD_SERVER=OFF \
          -DGGML_METAL=ON \
          -DGGML_METAL_EMBED_LIBRARY=ON \
          -DWHISPER_COREML=ON \
          -S .
        cmake --build build-macos --config Release
        
        # Create framework structure
        mkdir -p build-macos/framework/whisper.framework/Versions/A/Headers
        mkdir -p build-macos/framework/whisper.framework/Versions/A/Resources
        
        # Create symlinks
        ln -s A build-macos/framework/whisper.framework/Versions/Current
        ln -s Versions/Current/Headers build-macos/framework/whisper.framework/Headers
        ln -s Versions/Current/Resources build-macos/framework/whisper.framework/Resources
        ln -s Versions/Current/whisper build-macos/framework/whisper.framework/whisper
        
        # Copy headers
        cp include/whisper.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml-alloc.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml-backend.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml-metal.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml-cpu.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/ggml-blas.h build-macos/framework/whisper.framework/Versions/A/Headers/
        cp ggml/include/gguf.h build-macos/framework/whisper.framework/Versions/A/Headers/
        
        # Create module map
        cat > build-macos/framework/whisper.framework/Versions/A/Headers/module.modulemap << EOF
        framework module whisper {
            header "whisper.h"
            header "ggml.h"
            header "ggml-alloc.h"
            header "ggml-backend.h"
            header "ggml-metal.h"
            header "ggml-cpu.h"
            header "ggml-blas.h"
            header "gguf.h"

            link "c++"
            link framework "Accelerate"
            link framework "Metal"
            link framework "Foundation"
            link framework "CoreML"

            export *
        }
        EOF
        
        # Check what static libraries exist
        echo "ðŸ” Checking available static libraries..."
        find build-macos -name "*.a" -type f | sort
        
        # Gather existing libraries
        LIBS=()
        for lib in \
          "build-macos/src/Release/libwhisper.a" \
          "build-macos/ggml/src/Release/libggml.a" \
          "build-macos/ggml/src/Release/libggml-base.a" \
          "build-macos/ggml/src/Release/libggml-cpu.a" \
          "build-macos/ggml/src/ggml-metal/Release/libggml-metal.a" \
          "build-macos/ggml/src/ggml-blas/Release/libggml-blas.a" \
          "build-macos/src/Release/libwhisper.coreml.a"
        do
          if [ -f "$lib" ]; then
            echo "âœ… Found: $lib"
            LIBS+=("$lib")
          else
            echo "âŒ Missing: $lib"
          fi
        done
        
        # Combine static libraries into a dynamic framework
        echo "ðŸ”— Combining ${#LIBS[@]} static libraries..."
        libtool -static -o build-macos/temp_combined.a "${LIBS[@]}" 2>/dev/null
        
        # Verify combined library was created
        if [ ! -f "build-macos/temp_combined.a" ]; then
          echo "âŒ Failed to create combined static library"
          exit 1
        fi
        echo "âœ… Combined static library created: $(du -h build-macos/temp_combined.a)"
        
        # Create dynamic library from static
        echo "ðŸ”— Creating dynamic framework library..."
        clang++ -dynamiclib \
          -target arm64-apple-macos14.0 \
          -Wl,-all_load build-macos/temp_combined.a \
          -framework Foundation \
          -framework Metal \
          -framework Accelerate \
          -framework CoreML \
          -install_name @rpath/whisper.framework/Versions/Current/whisper \
          -o build-macos/framework/whisper.framework/Versions/A/whisper
        
        # Verify dynamic library was created
        if [ ! -f "build-macos/framework/whisper.framework/Versions/A/whisper" ]; then
          echo "âŒ Failed to create dynamic framework library"
          exit 1
        fi
        echo "âœ… Dynamic framework library created: $(du -h build-macos/framework/whisper.framework/Versions/A/whisper)"
        
        # Clean up temp file
        rm -f build-macos/temp_combined.a
        
        # Create Info.plist
        cat > build-macos/framework/whisper.framework/Versions/A/Resources/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>whisper</string>
            <key>CFBundleIdentifier</key>
            <string>org.ggml.whisper</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>whisper</string>
            <key>CFBundlePackageType</key>
            <string>FMWK</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>MinimumOSVersion</key>
            <string>14.0</string>
            <key>CFBundleSupportedPlatforms</key>
            <array>
                <string>MacOSX</string>
            </array>
            <key>DTPlatformName</key>
            <string>macosx</string>
            <key>DTSDKName</key>
            <string>macosx14.0</string>
        </dict>
        </plist>
        EOF
        
        # Create the final XCFramework directory structure
        mkdir -p build-apple
        
        # Create XCFramework from the framework
        echo "ðŸ”— Creating XCFramework..."
        xcodebuild -create-xcframework \
          -framework build-macos/framework/whisper.framework \
          -output build-apple/whisper.xcframework
        
        # Verify XCFramework creation
        if [ ! -d "build-apple/whisper.xcframework" ]; then
          echo "âŒ Failed to create XCFramework"
          exit 1
        fi
        echo "âœ… XCFramework created successfully"
        
        # Debug: Show what was created
        echo "XCFramework contents:"
        find build-apple/whisper.xcframework -type f | head -20
        
        # List the complete XCFramework structure
        echo "Complete XCFramework structure:"
        tree build-apple/whisper.xcframework || find build-apple/whisper.xcframework -print | sed -e 's;[^/]*/;|____;g;s;____|; |;g'
        
        # Verify critical components exist
        echo "ðŸ” Verifying XCFramework components..."
        XCFW_FRAMEWORK_PATH="build-apple/whisper.xcframework/macos-arm64/whisper.framework"
        
        # Check framework binary
        if [ -f "$XCFW_FRAMEWORK_PATH/whisper" ]; then
          echo "âœ… Framework binary present in XCFramework"
          file "$XCFW_FRAMEWORK_PATH/whisper"
        else
          echo "âŒ Framework binary missing in XCFramework"
          exit 1
        fi
        
        # Check module map
        if [ -f "$XCFW_FRAMEWORK_PATH/Headers/module.modulemap" ]; then
          echo "âœ… Module map present in XCFramework"
        else
          echo "âŒ Module map missing in XCFramework"
          exit 1
        fi
        
        # Check essential headers
        for header in whisper.h ggml.h; do
          if [ -f "$XCFW_FRAMEWORK_PATH/Headers/$header" ]; then
            echo "âœ… Header $header present"
          else
            echo "âŒ Header $header missing"
            exit 1
          fi
        done
        
    - name: Verify whisper.cpp build
      run: |
        # Verify framework was created
        if [ ! -f "whisper.cpp/build-macos/framework/whisper.framework/whisper" ]; then
          echo "âŒ Error: whisper framework was not built successfully"
          exit 1
        fi
        echo "âœ… whisper framework found"
        
        # Verify XCFramework was created
        if [ ! -d "whisper.cpp/build-apple/whisper.xcframework" ]; then
          echo "âŒ Error: whisper.xcframework was not created successfully"
          exit 1
        fi
        echo "âœ… whisper.xcframework found"
        
        # Check XCFramework structure
        echo "ðŸ” Checking XCFramework structure..."
        ls -la whisper.cpp/build-apple/whisper.xcframework/
        if [ -d "whisper.cpp/build-apple/whisper.xcframework/macos-arm64" ]; then
          echo "âœ… Found macos-arm64 directory"
          ls -la whisper.cpp/build-apple/whisper.xcframework/macos-arm64/
          
          # Check if the framework exists in XCFramework
          echo "ðŸ” Checking for framework in XCFramework..."
          if [ -d "whisper.cpp/build-apple/whisper.xcframework/macos-arm64/whisper.framework" ]; then
            echo "âœ… Found whisper.framework in XCFramework"
            
            # Check for module map
            if [ -f "whisper.cpp/build-apple/whisper.xcframework/macos-arm64/whisper.framework/Headers/module.modulemap" ]; then
              echo "âœ… Found module.modulemap"
              echo "ðŸ“‹ Module map contents:"
              cat whisper.cpp/build-apple/whisper.xcframework/macos-arm64/whisper.framework/Headers/module.modulemap
            else
              echo "âŒ module.modulemap not found"
              exit 1
            fi
          else
            echo "âŒ whisper.framework not found in XCFramework"
            echo "Contents of macos-arm64:"
            ls -la whisper.cpp/build-apple/whisper.xcframework/macos-arm64/
            exit 1
          fi
        else
          echo "âŒ macos-arm64 directory not found"
          echo "Available directories:"
          find whisper.cpp/build-apple/whisper.xcframework -type d
          exit 1
        fi
        
        # Verify library architecture
        echo "ðŸ” Verifying framework binary architecture..."
        FRAMEWORK_BINARY="whisper.cpp/build-macos/framework/whisper.framework/whisper"
        file "$FRAMEWORK_BINARY"
        lipo -archs "$FRAMEWORK_BINARY"
        
        if lipo -archs "$FRAMEWORK_BINARY" | grep -q "arm64"; then
          echo "âœ… Framework binary contains Apple Silicon (arm64) architecture"
        else
          echo "âŒ Framework binary missing Apple Silicon (arm64) architecture"
          exit 1
        fi
        
    - name: List Xcode schemes
      run: xcodebuild -project VoiceInk.xcodeproj -list
      
    - name: Check XCFramework availability for Xcode
      run: |
        echo "ðŸ” Checking if XCFramework is accessible for Xcode build..."
        if [ -d "whisper.cpp/build-apple/whisper.xcframework" ]; then
          echo "âœ… XCFramework directory exists"
          
          # Check if the XCFramework is valid
          echo "ðŸ” Validating XCFramework..."
          xcodebuild -checkFirstLaunchStatus || true
          
          # Try to get framework info
          if xcodebuild -showsdks >/dev/null 2>&1; then
            echo "âœ… Xcode tools are working"
          else
            echo "âŒ Xcode tools issue detected"
          fi
          
          # Check the specific framework binary
          FRAMEWORK_PATH="whisper.cpp/build-apple/whisper.xcframework/macos-arm64/whisper.framework"
          if [ -f "$FRAMEWORK_PATH/whisper" ]; then
            echo "âœ… Framework binary exists at: $FRAMEWORK_PATH/whisper"
            file "$FRAMEWORK_PATH/whisper"
            otool -l "$FRAMEWORK_PATH/whisper" | grep -A 3 LC_ID_DYLIB || echo "No LC_ID_DYLIB found"
          else
            echo "âŒ Framework binary not found at: $FRAMEWORK_PATH/whisper"
            ls -la "$FRAMEWORK_PATH" || echo "Framework directory doesn't exist"
          fi
          
          # Check headers
          HEADERS_PATH="$FRAMEWORK_PATH/Headers"
          if [ -d "$HEADERS_PATH" ]; then
            echo "âœ… Headers directory exists"
            echo "Headers:"
            ls -la "$HEADERS_PATH"
          else
            echo "âŒ Headers directory not found"
          fi
          
        else
          echo "âŒ XCFramework not found!"
          exit 1
        fi
        
    - name: Test whisper module import
      run: |
        echo "ðŸ§ª Testing whisper module import..."
        
        # Create a simple test file to check if the module can be imported
        cat > test_import.swift << 'EOF'
        import Foundation
        #if canImport(whisper)
        import whisper
        print("âœ… Successfully imported whisper module")
        #else
        print("âŒ Cannot import whisper module")
        #endif
        EOF
        
        # Try to compile the test
        echo "ðŸ”¨ Attempting to compile test import..."
        swiftc -sdk $(xcrun --show-sdk-path --sdk macosx) \
          -target arm64-apple-macos14.0 \
          -F whisper.cpp/build-apple \
          -framework whisper \
          -o test_import \
          test_import.swift || echo "âŒ Test compilation failed"
        
        # If compilation succeeded, run the test
        if [ -f test_import ]; then
          echo "ðŸƒ Running import test..."
          ./test_import || echo "âŒ Test execution failed"
          rm test_import
        fi
        
        rm test_import.swift
        
    - name: Build VoiceInk
      run: |
        echo "ðŸ”¨ Building VoiceInk with verbose output..."
        xcodebuild -project VoiceInk.xcodeproj \
          -scheme VoiceInk \
          -configuration Debug \
          -derivedDataPath build \
          -destination 'platform=macOS,arch=arm64' \
          -allowProvisioningUpdates \
          ARCHS='arm64' \
          VALID_ARCHS='arm64' \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -verbose \
          build
          
    - name: Verify build artifacts
      run: |
        ls -la build/Build/Products/Debug/
        if [ -d "build/Build/Products/Debug/VoiceInk.app" ]; then
          echo "âœ… VoiceInk.app built successfully"
          du -sh build/Build/Products/Debug/VoiceInk.app
          
          # Verify the binary is built for Apple Silicon
          echo "ðŸ” Verifying architecture..."
          file build/Build/Products/Debug/VoiceInk.app/Contents/MacOS/VoiceInk
          lipo -archs build/Build/Products/Debug/VoiceInk.app/Contents/MacOS/VoiceInk
          
          # Check if the binary contains arm64 architecture
          if lipo -archs build/Build/Products/Debug/VoiceInk.app/Contents/MacOS/VoiceInk | grep -q "arm64"; then
            echo "âœ… Binary contains Apple Silicon (arm64) architecture"
          else
            echo "âŒ Binary does not contain Apple Silicon (arm64) architecture"
            exit 1
          fi
        else
          echo "âŒ VoiceInk.app not found"
          exit 1
        fi
          
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: VoiceInk-build-${{ github.sha }}
        path: |
          build/Build/Products/Debug/VoiceInk.app
          whisper.cpp/build-macos/framework/whisper.framework
          whisper.cpp/build-apple/whisper.xcframework
        retention-days: 30
        
    - name: Test with build script
      run: |
        echo "Testing build script..."
        chmod +x build.sh
        # Don't actually run it since we already built, just check syntax
        bash -n build.sh
        echo "âœ… Build script syntax is valid" 